# 分布式锁

#### Redis 中的分布式锁

从 2.8 版本只收, set 指令加入了拓展参数,使得 setnx 和 expire 指令可以一起执行,

```r
set key true ex 5 nx
//do sth
del key// 删除 key
```

- 如果存在 key ,就设置为 ture,然后设置 5 秒过期

## 超时了怎么办

加随机数,key 使用一个随机数,删除的时候判断是不是这个随机数,如果是才删除

```
tag = redom.netint()
if redis.set(key,tag,nx=True,ex=5):
	do_something()
  redis.delifequals(key,tag)
```



## lua 脚本实现

```
#delifequals
if redis.call ("get",KEY[1]) == ARGV[1] then
	return redis.call("del",KEYS[1])
else
	return 0
end
```

并不是一个完美的实现,相对安全一点,如果真的超时了,当线程的逻辑没有执行完,其他的线程也会趁虚而入