# 020-Redis主从复制的不足

[TOC]

主从模式解决了数据备份和性能（通过读写分离）的问题，但是还是存在一些不足：

- RDB 文件过大的情况下，同步非常耗时。
- 在一主一从或者一主多从的情况下，如果主服务器挂了，对外提供的服务就不可 用了，单点问题没有得到解决。如果每次都是手动把之前的从服务器切换成主服务器， 这个比较费时费力，还会造成一定时间的服务不可用。 

#### 无盘复制

主节点在进行快照同步时,会进行很耗时的文件 IO 操作,在非 SSD磁盘存储时,快照同步会对系统的负载产生较大影响,特别是当系统正在进行 AOF的 fsync 操作时,如果发生快照同步,fsync 将会被推迟执行,这样就会严重影响主节点的服务效率

所以需要无盘复制

主服务器一边遍历内存,一边将序列化的内容发给从节点,从节点还是跟以前一样,先接收到再存储到硬盘

#### wait 指令

wait 指令可以让一步复制变身为同步复制,确保系统的强一致性(不严格)

wait 指令时 Redis3.0 版本以后才出来的

```
set key value 
wait 1 0
```

- 第一个参数是从节点的数量 N, 

- 第二个参数是时间 t,以毫秒为单位

等待 wait 指令之前的所有写操作同步到 N个从节点上, 也就是确保 N 个节点的同步没有之后,最多等待 t 时间,如果 t=0 标识无线等待到 N 个从节点同步完成

> 假设这个时候出现网络分区,wait 指令第二个参数时间 t=0 会导致主从同步无法继续进行,wait 指令会永远在阻塞,Redis 会丧失一致性





