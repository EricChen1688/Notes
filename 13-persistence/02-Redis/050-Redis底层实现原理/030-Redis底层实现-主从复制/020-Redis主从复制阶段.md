# 020-Redis主从复制阶段

[TOC]

## 主从复制阶段总结

- [连接阶段](#连接阶段)
- [数据同步阶段](#数据同步阶段)
- [命令传播阶段](#命令传播阶段)
- [值得注意的问题](#值得注意的问题)

#### 值得注意的问题

- [生成RDB期间master接收到的命令怎么处理](#生成RDB期间master接收到的命令怎么处理)

- [主节点和从节点之间有延迟怎么办](#主节点和从节点之间有延迟怎么办)

- [如果从节点有一段时间断开了与主节点的连接是不是要重新全量复制一遍](#如果从节点有一段时间断开了与主节点的连接是不是要重新全量复制一遍 ) 

## 连接阶段

- slave node 启动时 （执行 slaveof)命令， 会在自己本地保存 master node 的信息，包括master node 的 host 和 ip

- slave node 内部有个定时任务 replicationCon （源码 replication.c），**每隔 1 秒**钟检查是否有新的 master node 要连接和复制，如果发现，就跟 master node 建立  socket 网络连接，如果连接成功，从节点为该 socket 建立一个专门处理复制工作的文件 事件处理器，负责后续的复制工作，如接收 RDB 文件、接收命令传播等。

当从节点变成了主节点的一个客户端之后，会给主节点发送 ping 请求。 

## 数据同步阶段

- master node 第一次执行全量复制，通过 bgsave 命令在本地生成一份 RDB 快 照，将 RDB 快照文件发给 slave node（如果超时会重连，可以调大 repl-timeout 的值）。 

slave node 首先清除自己的旧数据，然后用 RDB 文件加载数据

## 命令传播阶段

- master node 持续将写命令，异步复制给 slave node

延迟是不可避免的，只能通过优化网络。

## 值得注意的问题

#### 生成RDB期间master接收到的命令怎么处理

开始生成 RDB 文件时，master 会把所有新的写命令缓存在内存中。在 slave node保存了 RDB 之后，再将新的写命令复制给 slave node。

#### 主节点和从节点之间有延迟怎么办

延迟是不可避免的，只能通过优化网络。

```
repl-disable-tcp-nodelay no -- 攒多个命令再发送
```

当设置为 yes 时，TCP 会对包进行合并从而减少带宽，但是发送的频率会降低，从 节点数据延迟增加，一致性变差；具体发送频率与 Linux 内核的配置有关，默认配置为 40ms。当设置为 no 时，TCP 会立马将主节点的数据发送给从节点，带宽增加但延迟变小。

一般来说，只有当应用对 Redis 数据不一致的容忍度较高，且主从节点之间网络状 况不好时，才会设置为 yes；多数情况使用默认值 no

#### 如果从节点有一段时间断开了与主节点的连接是不是要重新全量复制一遍

通过 master_repl_offset 记录的偏移量 ，从节点根据偏移量告诉主节点自己复制到哪了

> redis> info replication