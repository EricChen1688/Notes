# 020-Redis持久化-AOF持久化

[TOC]

## 什么是AOF持久化

Redis 默认不开启。

AOF 采用日志的形式来记录每个写操作，并追加到文件中。开启后，执行更改 Redis 数据的命令时，就会把命令写入到 AOF 文件中。
Redis 重启时会根据日志文件的内容把写指令从前到后执行一次以完成数据的恢复工作。

## AOF 文件的内容

直接用 vim 查看

![image-20200624145740128](../../../../assets/image-20200624145740128.png)

## AOF 配置

Append Only File

```
# 开关 Redis 默认只开启 RDB 持久化，开启 AOF 需要修改为 yes
appendonly no
# 文件名 路径也是通过 dir 参数配置 config get dir
appendfilename "appendonly.aof"
```

## 数据都是实时持久化到磁盘吗?

由于操作系统的缓存机制，AOF 数据并没有真正地写入硬盘，而是进入了系统的硬盘缓存。什么时候把缓冲区的内容写入到 AOF 文件?

| 参数                 | 说明                                                         |
| -------------------- | ------------------------------------------------------------ |
| appendfsync everysec | AOF 持久化策略(硬盘缓存到磁盘)，默认 everysec<br/>1. no 表示不执行fsync，由操作系统保证数据同步到磁盘，速度最快，但是不太安全; <br />2. always 表示每次写入都执行 fsync，以保证数据同步到磁盘，效率很低;<br/>3. everysec 表示每秒执行一次 fsync，可能会导致丢失这 1s 数据。通常选择 everysec <br/>兼顾安全性和效率。 |

## 文件越来越大，怎么办?

由于 AOF 持久化是 Redis 不断将写命令记录到 AOF 文件中，随着 Redis 不断的进 行，AOF 的文件会越来越大，文件越大，占用服务器内存越大以及 AOF 恢复要求时间 越长。

## AOF 数据恢复

重启 Redis 之后就会进行 AOF 文件的恢复。

## AOF 的优缺点

- AOF 持久化的方法提供了多种的同步频率，即使使用默认的同步频率每秒同步 一次，Redis 最多也就丢失 1 秒的数据而已

#### 缺点

- 对于具有相同数据的的 Redis，AOF 文件通常会比 RDF 文件体积更大(RDB 存的是数据快照)。
- 虽然 AOF 提供了多种同步的频率，默认情况下，每秒同步一次的频率也具有较 高的性能。在高并发的情况下，RDB 比 AOF 具好更好的性能保证。