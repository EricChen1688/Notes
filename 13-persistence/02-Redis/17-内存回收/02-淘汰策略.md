# 淘汰策略

Redis 内存超出物理内存限制时,内存的数据会开始和磁盘产生频繁的交换,交换会让 Redis 的性能急剧下降

> 在生产环境中我们不允许 Redis 出现交换行为,为了限制最大使用内存,Redis 提供了配置参数 maxmemory 来限制内存超出预期的大小

## Redis 提供的策略

Redis 的内存淘汰策略，是指当内存使用达到最大内存极限时，需要使用淘汰算法来 决定清理掉哪些数据，以保证新数据的存入。

#### 最大内存设置

redis.conf

```
# maxmemory <bytes>
```

如果不设置 maxmemory 或者设置为 0，64 位系统不限制内存，32 位系统最多使 用 3GB 内存。

动态修改

```
redis> config set maxmemory 2GB
```

## 淘汰算法



| 策略            | 含义                                                         |
| --------------- | ------------------------------------------------------------ |
| noeviction      | 默认策略，不会删除任何数据，拒绝所有写入操作并返回客户端错误信息(error)OOM command not allowed when used memory，此时 Redis 只响应读操作。 |
| allkeys-lru     | 根据 LRU 算法删除键，不管数据有没有设置超时属性，直到腾出足够内存为止。 |
| allkeys-random  | 随机删除所有键，直到腾出足够内存为止。                       |
| allkeys-lfu     | 在所有的键中选择最不常用的，不管数据有没有设置超时属性。     |
| volatile-ttl    | 根据键值对象的 ttl 属性，删除最近将要过期数据。如果没有，回退到 noeviction 策略。 |
| volatile-random | 在带有过期时间的键中随机选择。                               |
| volatile-lru    | 根据 LRU 算法删除设置了超时属性(expire)的键，直到腾出足够内存为止。如果没有 可删除的键对象，回退到 noeviction 策略。 |
| volatile-lfu    | 在带有过期时间的键中选择最不常用的。                         |
|                 |                                                              |
|                 |                                                              |



- volatile-xxx 策略只会针对带过期时间的 key 进行淘汰
- allkeys-xxx 策略会对所有 key 进行太太

## 应用场景

- 如果你只是拿 Redis 做缓存,那么应该使用 allkey 策略,客户端写缓存时不必携带过期时间
- 如果你同时想使用 Redis 持久化功能,那就使用 volatile-xxx 策略,这样可以保留没有设置过期时间的 key,他们是永久的 key,不会被 LRU 算法淘汰



> ##### lru (Least Recently Used 最近最少使用) 淘汰
>
> - volatile-lru
>   根据 LRU 算法删除设置了超时属性(expire)的键，直到腾出足够内存为止。如果没有 可删除的键对象，回退到 noeviction 策略。
> - allkeys-lru
>   根据 LRU 算法删除键，不管数据有没有设置超时属性，直到腾出足够内存为止。
>
> ##### lfu(最不常用) 淘汰
>
> - volatile-lfu
>   在带有过期时间的键中选择最不常用的。
> - allkeys-lfu
>   在所有的键中选择最不常用的，不管数据有没有设置超时属性。
>
> ##### 随机淘汰
>
> - volatile-random
>   在带有过期时间的键中随机选择。
> - allkeys-random
>   随机删除所有键，直到腾出足够内存为止。
>
> ##### 根据 ttl 淘汰
>
> - volatile-ttl
>   根据键值对象的 ttl 属性，删除最近将要过期数据。如果没有，回退到 noeviction 策略。
>
> ##### 默认淘汰
>
> - noeviction
>   默认策略，不会删除任何数据，拒绝所有写入操作并返回客户端错误信息(error)OOM command not allowed when used memory，此时 Redis 只响应读操作。
>



