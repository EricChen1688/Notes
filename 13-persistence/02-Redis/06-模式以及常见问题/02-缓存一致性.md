# 缓存一致性

因为这些数据是很少修改的，所以在绝大部分的情况下可以命中缓存。但是，一旦 被缓存的数据发生变化的时候，我们既要操作数据库的数据，也要操作 Redis 的数据， 所以问题来了。现在我们有两种选择:

- 先操作 Redis 的数据再操作数据库的数据
- 先操作数据库的数据再操作 Redis 的数据

首先需要明确的是，不管选择哪一种方案， 我们肯定是希望两个操作要么都成功，要么都一个都不成功。不然就会发生 Redis 跟数据库的数据不一致的问题。

但是，Redis 的数据和数据库的数据是不可能通过事务达到统一的，我们只能根据相 应的场景和所需要付出的代价来采取一些措施降低数据不一致的问题出现的概率，在数据**一致性**和**性能**之间取得一个权衡

由于我们是以数据库的数据为准的，所以给缓存设置一个过期时间，是保证最终一致性的解决方案。

### 先操作 Redis 的数据再操作数据库的数据?

异常情况: 

- 更新数据库失败，程序捕获异常，不会走到下一步，所以数据不会出现不一致。 
- 更新数据库成功，删除缓存失败。数据库是新数据，缓存是旧数据，发生了不一致的情况。

解决办法: 重试

- 如果缓存删除失败,捕获到以后 retry ,要删除的 key 发送到消息队列

### 先删除缓存,再更新数据库

- 删除缓存，程序捕获异常，不会走到下一步，所以数据不会出现不一致。
- 删除缓存成功，更新数据库失败。 因为以数据库的数据为准，所以不存在数据
  不一致的情况。

看起来好像没问题，但是如果有程序并发操作的情况下:

- 线程 A 需要更新数据，首先删除了 Redis 缓存
- 线程 B 查询数据，发现缓存不存在，到数据库查询旧值，写入 Redis，返回 3)线程 A 更新了数据库

解决办法:延迟双删

在写入数据之后，再删除一次缓存

A 线程: 

1. 删除缓存
2. 更新数据库
3. 休眠 500ms(这个时间，依据读取数据的耗时而定) 
4. 再次删除缓存

## 删除还是更新

这里我们先要补充一点，当存储的数据发生变化，Redis 的数据也要更新的时候，我 们有两种方案:

- 直接更新，调用 set;
- 直接删除缓存，让应用在下次 查询的时候重新写入。

这两种方案怎么选择呢?这里我们主要考虑更新缓存的代价。
更新缓存之前，是不是要经过其他表的查询、接口调用、计算才能得到最新的数据， 而不是直接从数据库拿到的值。如果是的话，建议直接删除缓存，这种方案更加简单， 而且避免了数据库的数据和缓存不一致的情况。在一般情况下，我们也推荐使用删除的方案。

