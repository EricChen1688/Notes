# 持久化机制

Redis 有两个持久化机制

- RDB 快照 , 全量备份,是内存数据的二进制序列化存储,恢复速度快
- AOF 日志 , 增量备份,是内存数据修改的指令记录的文本 ,恢复速度慢



## RDB快照

Redis 是单线程的,内存快照肯定会用到 IO,可文件 IO 不能使用多路复用的 API

#### COW 机制 

Redis 使用 Copy on Write (cow) 机制来实现快照持久化, Redis 在持久化的过程中会 fork 一个子线程,快照持久化完全按照子进程处理,父进程继续处理客户端

子进程过程:

- 父进程在接受客户端请求时,使用操作系统的 cow 机制,复制原有的页数据,在复制的基础上更改

- 遍历原有的页数据数据结构,读取后序列化到磁盘中

## AOF

AOF 日志存储的 Redi服务器的顺序序列,AOF 日志只记录对内存操作进行修改的指令,随着Redis 运行时间边长,AOF 日志也会越来越臃肿,如果实例宕机,重放整个 aof 日志非常耗时,所以需要对 AOF 进行重写瘦身

## AOF 重写

aof 日志在长期运行过程中会变得无比强大,数据库重启的时候需要加载 aof 日志进行指令的重返,这个时间无比漫长,所以要对 AOF 定期重写, 给 AOF 瘦身

> bgrewriteaof 指令 用于对 AOF日志进行瘦身

原理就是开辟一个子进程对内存进行遍历,序列化到一个新的 aof 日志文件中,序列化完成之后再讲操作期间发生的增量 aof日志追加到这个新的 aof 日志文件中,追加完毕之后就立即替代就的 aof 文件了,瘦身工作就完成了

### fsync

Linux 的 glibc 提供了fsync 函数可以将制定文件从内核缓存总刷到磁盘,但是 fsync 是个磁盘 IO 操作,很慢

生产环境中,通常是使用每隔 1s 刷新一次

## Redis 4.0 混合持久化

- RDB恢复快,但是会丢失数据
- AOF恢复慢,但是数据不会丢失

所以要混合持久化

Redis 在重启的时候,先加载 rdb 的内容,然后再重放增量 aof ,就可以完全替代之前的 AOF 全量文件重放