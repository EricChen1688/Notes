# 布隆过滤器

布隆过滤器可以理解为一个不是特别精确的 set 结构,可以使用 bf.exists 方法判断对象是否存在,它在去重的同时,空间上能节省 90%以上,但是存在一定的误判几率

- 布隆过滤器说有这个值的时候,这个值不一定存在
- 布隆过滤器说不存在这个值的时候,这个值一定不存在

## 使用

使用插件的形式集成到 redis

## 启动的时候指定参数

- key:
- error_rate : 错误率,默认是 0.01
- initial_size: 标识预计放入的元素的数量, 默认是 100

如果 initial_size 配置的过大,会浪费存储空间,设置的过小,就会影响准确率,用户在使用之前一定要尽可能地精确评估元素的数量,还要加上一定的冗余空间避免实际元素可能意外高出评估值的值很多

布隆过滤器的 error_rate 越小,需要的存储空间就越大,对于不需要过于精确的场合,errror_rate 可以设置稍微大一点,比如新闻客户端去重,误判率高一点只会让小部分文章不能被合适的人看到,文章整体阅读量不会受到大的变化无伤大雅

## 布隆过滤器的原理

每个布隆过滤器对应到的 Redis 的数据结构就是一个大型的位数组和几个不一样的无偏 hash 函数

- 所谓的无偏 hash 函数,就是能够把元素的 hash 值算的比较均匀,让元素被 hash 映射到位数组中的位置比较随机

实现流程:

- add , 首先布隆过滤器会使用多个 hash 函数对 key进行 hash, 算得一个整数索引值,然后对数组长度进行一个取模运算,得到一个位置,每个 hash 函数得到的都会得到不同的位置,再把位数组的这几个位置都置为 1 

- bf.exists 操作, 和 add 一样,用不同的 hash 后取模数组长度获得位置,然后判断这几个位置是否都是 1,只要有一位是 0,那么说明这个 key不存在

## 为什么不精确

因为位置是 1 的地方有可能是别的 key 进行 hash 的时候碰撞了导致的

- 如果数组比较稀疏,那么正确率就高一点
- 如果数组比较拥挤,那么概率就会低一点

