# 管道

**管道的本质并不是服务器提供的特性,而是客户端通过改变读写顺序,带来性能的较大提升**

客户端技术,通过对管道中的指令列表改变读写顺序就可以大幅节省 IO 时间,管道中的指令阅读,效果就越好

## 怎么做

客户端改变读写顺序

改变之前

- 写-读-写-读

  写直接写到缓冲区,所以直接就直接返回,读会等待一次网络 IO 将数据读到缓冲区 ,所以这一句有两个网络 IO

改变之后

- 写-写-读-读

一样,写没有开销,连续的两次读只要一个网络 IO





![image-20200419134701046](assets/image-20200419134701046.png)

1. 客户端调用 write 方法将消息写到操作系统内核, 为套接字分配的发送缓冲区 send bufer 中
2. 客户端操作系统内核将发送缓冲的内容发送到网卡,网卡硬件将数据通过网际路由发送到服务器的网卡
3. 服务器操作系统内核将网卡的数据放到内核为套接字分配的接收缓冲区recv buffer 中
4. 服务器进程调用 read 从接收缓冲去中去除消息并进行处理
5. 同 1 
6. 同 2
7. 同 3
8. 客户端进程调用 read 方法接收到进行处理
9. 结束

#### 值得注意的是

write 操作值负责写到缓冲区后就返回了

read 操作值负责将数据从本地操作系统内核的接受缓冲中取出来,如果缓冲是空的,就会等待

#### 所以对于管道来说:

**连续的 write 操作根本没有耗时(写到缓冲区就返回),之后第一个 read 操作会等待一个网络的来回开销,然后所有的相应消息就都已经送回到内核的读缓冲了,后续的 read 操作之久就可以从缓冲中拿到结果,瞬间就返回了**