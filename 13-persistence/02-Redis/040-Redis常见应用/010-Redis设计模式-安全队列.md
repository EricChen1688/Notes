# 010-Redis设计模式-安全队列

## 一句话概括

可以使用 `RPOPLPUSH `命令做一个安全的队列 , 使用一个备份表, 将获取的数据塞入备份表,正确处理完成后再从备份表中删除

## 命令

 [rpoplpush](../011-数据类型-list/010-基础命令.md#rpoplpush) 

## 详细

Redis的列表经常被用作队列 (queue) ，用于在不同程序之间有序地交换消息 (message)

具体操作如下

- 生产者 A 通过命令 `LPUSH key value ` 命令将消息放入队列
- 客户端 B 通过命令 来获取消息
  - `RPOP key` 直接获取
  - `BRPOP key timeout` 超时等待

#### 这种方式不安全

为什么不安全?

**因为在这个过程中,一个客户端可能在获取一个消息之后崩溃 , 而未处理完消息也就因此丢失**

## 如何实现一个安全的队列

- RPOPLPUSH 命令

- BRPOPLPUSH 命令 :  阻塞版本

可以解决这个问题, 因为它不仅仅返回一个消息,同时还可以将这个消息添加到另一个备份列表中去 

- 如果一切正常,客户端处理完消息后可以使用 `LREM key count value` 命令 将这个消息从备份表中删除

如果出现了异常,我们有两种方式解决

- 如果客户端未处理完消息,就崩溃了 ,那么只要在启动的时候获取备份表的数据进行二次消费
- 添加一个客户端专门用于监视备份表, 自动地将超过一定处理时限的消息重新放入队列中 (这个时候处理该消息的客户端可能已经崩溃)

