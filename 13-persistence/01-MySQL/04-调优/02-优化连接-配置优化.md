## 连接——配置优化

第一个环节是客户端连接到服务端，连接这一块有可能会出现什么样的性能问题? 有可能是服务端连接数不够导致应用程序获取不到连接。比如报了一个 `Mysql: error 1040: Too many connections` 的错误。

我们可以从两个方面来解决连接数不够的问题:

- 从服务端来说，我们可以增加服务端的可用连接数
- 从客户端来说，引入连接池，实现连接的重用

### 增加服务器的可用连接数

如果有多个应用或者很多请求同时访问数据库，连接数不够的时候，我们可以:

- 修改配置参数增加可用连接数，修改 max_connections 的大小:

```sql
show variables like 'max_connections';  -- 修改最大连接数，当有多个应用连接的时候
```

- 或者，或者及时释放不活动的连接。交互式和非交互式的客户端的默认超时时
  间都是 28800 秒，8 小时，我们可以把这个值调小。

```sql
show global variables like 'wait_timeout'; --及时释放不活动的连接，注意不要释放连接池还在使用的连接
```

## 客户端引入连接池(2c+1)

我们可以在哪些层面使用连接池?ORM 层面(MyBatis 自带了一个连接池);或者 使用专用的连接池工具(阿里的 Druid、Spring Boot 2.x 版本默认的连接池 Hikari、老牌的 DBCP 和 C3P0)。

当客户端改成从连接池获取连接之后，连接池的大小应该怎么设置呢?大家可能会有一个误解，觉得连接池的最大连接数越大越好，这样在高并发的情况下客户端可以获 取的连接数更多，不需要排队。

实际情况并不是这样。连接池并不是越大越好，只要维护一定数量大小的连接池， 其他的客户端排队等待获取连接就可以了。有的时候连接池越大，效率反而越低。

Druid 的默认最大连接池大小是 8。Hikari 的默认最大连接池大小是 10。 为什么默认值都是这么小呢?

在 Hikari 的 github 文档中，给出了一个 `PostgreSQL` 数据库建议的设置连接池大小
的公式:

> https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing 

它的建议是机器核数乘以 2 加 1。也就是说，4 核的机器，连接池维护 9 个连接就 够了。这个公式从一定程度上来说对其他数据库也是适用的。这里面还有一个减少连接 池大小实现提升并发度和吞吐量的案例。

#### 有时候减少连接数可以提高吞吐量

为什么有的情况下，减少连接数反而会提升吞吐量呢?为什么建议设置的连接池大 小要跟 CPU 的核数相关呢?每一个连接，服务端都需要创建一个线程去处理它。连接数越多，服务端创建的线程数就会越多。

CPU 是怎么同时执行远远超过它的核数大小的任务的?时间片。上下文切换。

而 CPU 的核数是有限的，频繁的上下文切换会造成比较大的性能开销。

在不同的硬件环境下，操作系统和 MySQL 的参数的配置是不同的，没有标准的配置。
在我们这几天的课程里面也接触了很多的 MySQL 和 InnoDB 的配置参数，包括各种 开关和数值的配置，大多数参数都提供了一个默认值，比如默认的 buffer_pool_size， 默认的页大小，InnoDB 并发线程数等等。

这些默认配置可以满足大部分情况的需求，除非有特殊的需求，在清楚参数的含义 的情况下再去修改它。修改配置的工作一般由专业的 DBA 完成。

如果想要了解一些特定的参数的含义，官网有一份系统的参数列表可以参考:

> https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html 

## 内存参数优化

#### 每一个connection内存参数配置

```
sort_buffer_size connection -- 排序缓冲区大小
```

建议256K(默认值)-> 2M之内

当查询语句中有需要文件排序功能时，马上为connection分配配置的内存大小

```
join_buffer_size connection -- 关联查询缓冲区大小
```

建议256K(默认值)-> 1M之内

 当查询语句中有关联查询时，马上分配配置大小的内存用这个关联查
询，所以有可能在一个查询语句中会分配很多个关联查询缓冲区 上述配置4000连接占用内存:
`4000*(0.256M+0.256M) = 2G`

```
Innodb_buffer_pool_size  --innodb buffer/cache的大小(默认128M)
```

Innodb_buffer_pool

- 数据缓存
- 索引缓存
- 缓冲数据
- 内部结构

大的缓冲池可以减小多次磁盘I/O访问相同的表数据以提高性能

参考计算公式:

```
Innodb_buffer_pool_size = (总物理内存 - 系统运行所用 - connection 所用)* 90%
```

### 其他参数

```
wait_timeout
    服务器关闭非交互连接之前等待活动的秒数
innodb_open_files 限制Innodb能打开的表的个数
innodb_write_io_threads innodb_read_io_threads
innodb使用后台线程处理innodb缓冲区数据页上的读写 I/O(输入输出)请求 innodb_lock_wait_timeout
InnoDB事务在被回滚之前可以等待一个锁定的超时秒数 

```

>  https://www.cnblogs.com/wyy123/p/6092976.html 常见配置的帖子

### 其他参数

```
[mysqld]
lower_case_table_names = 1 #不区分大小写
```

```
innodb_log_buffer_size = 2M
# 此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，但意外的故障将会丢失数据。MySQL开发人员建议设置为1－8M之间
```

```
key_buffer_size = 4M
#指定用于索引的缓冲区大小，增加它可得到更好处理的索引(对所有读和多重写)，到你能负担得起那样多。如果你使它太大，
# 系统将开始换页并且真的变慢了。对于内存在4GB左右的服务器该参数可设置为384M或512M。通过检查状态值Key_read_requests和Key_reads，
# 可以知道key_buffer_size设置是否合理。比例key_reads/key_read_requests应该尽可能的低，
# 至少是1:100，1:1000更好(上述状态值可以使用SHOW STATUS LIKE 'key_read%'获得)。注意：该参数值设置的过大反而会是服务器整体效率降低
```

```
tmp_table_size = 16M
# MySQL的heap（堆积）表缓冲大小。所有联合在一个DML指令内完成，并且大多数联合甚至可以不用临时表即可以完成。
# 大多数临时表是基于内存的(HEAP)表。具有大的记录长度的临时表 (所有列的长度的和)或包含BLOB列的表存储在硬盘上。
# 如果某个内部heap（堆积）表大小超过tmp_table_size，MySQL可以根据需要自动将内存中的heap表改为基于硬盘的MyISAM表。还可以通过设置tmp_table_size选项来增加临时表的大小。也就是说，如果调高该值，MySQL同时将增加heap表的大小，可达到提高联接查询速度的效果
```

```
sort_buffer_size = 8M
# MySQL执行排序使用的缓冲大小。如果想要增加ORDER BY的速度，首先看是否可以让MySQL使用索引而不是额外的排序阶段。
# 如果不能，可以尝试增加sort_buffer_size变量的大小
```

```
read_rnd_buffer_size = 8M
# MySQL的随机读缓冲区大小。当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，
# MySQL会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。但MySQL会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大
```

```
join_buffer_size = 8M
# 联合查询操作所能使用的缓冲区大小，和sort_buffer_size一样，该参数对应的分配内存也是每连接独享
```

```
max_allowed_packet = 4M
# 接受的数据包大小；增加该变量的值十分安全，这是因为仅当需要时才会分配额外内存。例如，仅当你发出长查询或MySQLd必须返回大的结果行时MySQLd才会分配更多内存。
# 该变量之所以取较小默认值是一种预防措施，以捕获客户端和服务器之间的错误信息包，并确保不会因偶然使用大的信息包而导致内存溢出。
```

```
read_buffer_size = 2M
# MySQL读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。
# 如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能
```

```
innodb_log_buffer_size = 2M
# 此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，但意外的故障将会丢失数据。MySQL开发人员建议设置为1－8M之间
```

