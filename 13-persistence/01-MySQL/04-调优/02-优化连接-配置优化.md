## 连接——配置优化

第一个环节是客户端连接到服务端，连接这一块有可能会出现什么样的性能问题? 有可能是服务端连接数不够导致应用程序获取不到连接。比如报了一个 Mysql: error 1040: Too many connections 的错误。

我们可以从两个方面来解决连接数不够的问题:

- 从服务端来说，我们可以增加服务端的可用连接数
- 从客户端来说，引入连接池，实现连接的重用

### 增加服务器的可用连接数

如果有多个应用或者很多请求同时访问数据库，连接数不够的时候，我们可以:

- 修改配置参数增加可用连接数，修改 max_connections 的大小:

```sql
show variables like 'max_connections';  -- 修改最大连接数，当有多个应用连接的时候
```

- 或者，或者及时释放不活动的连接。交互式和非交互式的客户端的默认超时时
  间都是 28800 秒，8 小时，我们可以把这个值调小。

```java
show global variables like 'wait_timeout'; --及时释放不活动的连接，注意不要释放连接池还在使用的连接
```

## 客户端引入连接池

我们可以在哪些层面使用连接池?ORM 层面(MyBatis 自带了一个连接池);或者 使用专用的连接池工具(阿里的 Druid、Spring Boot 2.x 版本默认的连接池 Hikari、老 牌的 DBCP 和 C3P0)。

当客户端改成从连接池获取连接之后，连接池的大小应该怎么设置呢?大家可能会 有一个误解，觉得连接池的最大连接数越大越好，这样在高并发的情况下客户端可以获 取的连接数更多，不需要排队。

实际情况并不是这样。连接池并不是越大越好，只要维护一定数量大小的连接池， 其他的客户端排队等待获取连接就可以了。有的时候连接池越大，效率反而越低。

Druid 的默认最大连接池大小是 8。Hikari 的默认最大连接池大小是 10。 为什么默认值都是这么小呢?

在 Hikari 的 github 文档中，给出了一个 PostgreSQL 数据库建议的设置连接池大小
的公式:
https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing

它的建议是机器核数乘以 2 加 1。也就是说，4 核的机器，连接池维护 9 个连接就 够了。这个公式从一定程度上来说对其他数据库也是适用的。这里面还有一个减少连接 池大小实现提升并发度和吞吐量的案例。

#### 有时候减少连接数可以提高吞吐量

为什么有的情况下，减少连接数反而会提升吞吐量呢?为什么建议设置的连接池大 小要跟 CPU 的核数相关呢?
每一个连接，服务端都需要创建一个线程去处理它。连接数越多，服务端创建的线程数就会越多。

CPU 是怎么同时执行远远超过它的核数大小的任务的?时间片。上下文切换。

而 CPU 的核数是有限的，频繁的上下文切换会造成比较大的性能开销。

在不同的硬件环境下，操作系统和 MySQL 的参数的配置是不同的，没有标准的配置。
在我们这几天的课程里面也接触了很多的 MySQL 和 InnoDB 的配置参数，包括各种 开关和数值的配置，大多数参数都提供了一个默认值，比如默认的 buffer_pool_size， 默认的页大小，InnoDB 并发线程数等等。

这些默认配置可以满足大部分情况的需求，除非有特殊的需求，在清楚参数的含义 的情况下再去修改它。修改配置的工作一般由专业的 DBA 完成。

如果想要了解一些特定的参数的含义，官网有一份系统的参数列表可以参考:
https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html