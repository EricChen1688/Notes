# Binlog

DML 语句会写到 redo log 里, 也会写到 binlog 里

binlog 叫做数据库的二进制日志文件,主要用于备份恢复和主从复制

- [记录的是什么](#记录的是什么)
- [刷新到磁盘的条件是什么](#刷新到磁盘的条件是什么)
- [流程](#流程)
- [主要作用是什么](#主要作用是什么)

## 记录的是什么

binlog 以事件的形式记录了所有的 DDL 和 DML 语句(因为它记录的是操作而不是 数据值，属于逻辑日志)，可以用来做主从复制和数据恢复。

跟 redo log 不一样，它的文件内容是可以追加的，没有固定大小限制。
在开启了 binlog 功能的情况下，我们可以把 binlog 导出成 SQL 语句，把所有的操作重放一遍，来实现数据的恢复。
binlog 的另一个功能就是用来实现主从复制，它的原理就是从服务器读取主服务器 的 binlog，然后执行一遍。

## 刷新条件是什么

sync_binlog 参数来决定的

#### sync_binlog = 1 时 , 更加安全

事务提交后,MySQL让文件系统自行决定什么时候同步

如果 cache 满了才会同步到磁盘

> 当sync_binlog = 1 , innodb_flush_log_at_trx_commit = 1 , 是双鞋模式,确保数据库更安全

#### sync_binlog = n 时 ,更关注性能

每进行 n 次事务提交,MySQL 会执行一次 fync 之类的磁盘同步命令强制写入磁盘

## 一条更新语句

配置方式和主从复制的实现原理在 Mycat 第二节课中有讲述。 有了这两个日志之后，我们来看一下一条更新语句是怎么执行的:

![image-20200820110307534](../../../assets/image-20200820110307534.png)

例如一条语句:update teacher set name='盆鱼宴' where id=1; 1、先查询到这条数据，如果有缓存，也会用到缓存。
2、把 name 改成盆鱼宴，然后调用引擎的 API 接口，写入这一行数据到内存，同时
记录 redo log。这时 redo log 进入 prepare 状态，然后告诉执行器，执行完成了，可 以随时提交。
3、执行器收到通知后记录 binlog，然后调用存储引擎接口，设置 redo log 为 commit 状态。
4、更新完成。

## 流程

1. 先记录到内存，再写日志文件。
2. 记录 redo log 分为两个阶段。 
3. 存储引擎和 Server 记录不同的日志。 
4. 先记录 redo，再记录 binlog。

## 主要作用是什么

- 恢复(recovery) : 某些数据的恢复需要二进制日志, 例如, 在一个数据库全备文件恢复后,用户可以通过而二进制日志进行 point-in-time 的恢复
- 复制(replication): 其原理与恢复类似,通过复制和执行二进制日志使一台远程的 MySQL 数据库(slave) 实时同步
- 审计(audit) 用户可以通过二进制日志中的信息来进行审计,判断是否对数据库进行诸如攻击

## 区别

 [09-binlog-redolog-undolog.md](../01-总体结构/09-binlog-redolog-undolog.md) 

