# 查询优化(Query Optimizer)与查询执行计划

> ![image-20200817085839538](../../../assets/image-20200817085839538.png)

## 一句话概括

查询优化器根据语法解析和预处理器生成的解析树,生成不同的执行计划,然后根据开销选择最佳的执行计划

## 什么是优化器?

这里我们有一个问题，一条 SQL 语句是不是只有一种执行方式?或者说数据库最终 执行的 SQL 是不是就是我们发送的 SQL?

这个答案是否定的。一条 SQL 语句是可以有很多种执行方式的，最终返回相同的结 果，他们是等价的。但是如果有这么多种执行方式，这些执行方式怎么得到的? 最终选择哪一种去执行? 根据什么判断标准去选择?

这个就是 MySQL 的**查询优化器**的模块(`Optimizer`)。

查询优化器的目的就是根据解析树生成不同的执行计划 (`Execution Plan`)，然后选择一种最优的执行计划，MySQL 里面使用的是基于`开销(cost)`的优化器，那种执行计 划开销最小，就用哪种。

可以使用这个命令查看查询的开销:

```sql
show status like 'Last_query_cost';
```

##  优化器可以做什么?

MySQL 的优化器能处理哪些优化类型呢? 举两个简单的例子:

- 当我们对多张表进行关联查询的时候，以哪个表的数据作为基准表。
- 有多个索引可以使用的时候，选择哪个索引。

实际上，对于每一种数据库来说，优化器的模块都是必不可少的，他们通过复杂的算法实现尽可能优化查询效率的目标。

但是优化器也不是万能的，并不是再垃圾的 SQL 语句都能自动优化，也不是每次都 能选择到最优的执行计划，大家在编写 SQL 语句的时候还是要注意。

#### 优化器是怎么得到执行计划的?

首先我们要启用优化器的追踪(默认是关闭的):

```java
SHOW VARIABLES LIKE 'optimizer_trace'; 
set optimizer_trace='enabled=on';
```

注意开启这开关是会消耗性能的，因为它要把优化分析的结果写到表里面，所以不 要轻易开启，或者查看完之后关闭它(改成 off)。

注意:参数分为 session 和 global 级别。

接着我们执行一个 SQL 语句，优化器会生成执行计划:

```sql
select t.tcid from teacher t,teacher_contact tc where t.tcid = tc.tcid;
```

这个时候优化器分析的过程已经记录到系统表里面了，我们可以查询:

```sql
select * from information_schema.optimizer_trace \G
```

它是一个 JSON 类型的数据，主要分成三部分，准备阶段、优化阶段和执行阶段。

![image-20200313200730102](../../../assets/image-20200313200730102.png)

- `expanded_query` 是优化后的 SQL 语句。 

- `considered_execution_plans` 里面列出了所有的执行计划。

```
set optimizer_trace="enabled=off";
SHOW VARIABLES LIKE 'optimizer_trace';
```

## 优化器得到的结果

优化完之后，得到一个什么东西呢?

优化器最终会把解析树变成一个查询执行计划，查询执行计划是一个数据结构。 当然，这个执行计划是不是一定是最优的执行计划呢? 不一定，因为 MySQL 也有可能覆盖不到所有的执行计划。

我们怎么查看 MySQL 的执行计划呢?比如多张表关联查询，先查询哪张表?在执行查询的时候可能用到哪些索引，实际上用到了什么索引?

MySQL 提供了一个执行计划的工具。我们在 SQL 语句前面加上 EXPLAIN，就可以看到执行计划的信息。

```sql
EXPLAIN select name from user where id=1;
```

**注意 Explain 的结果也不一定最终执行的方式。**