# [QA]介绍一下MySQL的集群架构

- M-S
- MHA
- MM+KeepAlived
- PXC
- 利用中间件ProxySQL配合PXC架构

## MHA的优缺点

优点:

- 故障切换时,可以自行判断哪个从库与主库的数据最接近,就切换到上面,可以减少数据丢失的风险,保证数据的一致性
- 支持 binlog server ,可提高binlog 传输效率, 进一步减少数据丢失风险
- 结合MySQL5.7 的增强半同步功能,来确保故障切换时的数据不丢失

缺点:

- 自动切换脚本太简单,而且比较老化,建议后期主键完善
- 搭建MHA架构,需要开启Linux系统互信协议,所以对于系统安全来说是一个不小的考验

## MM+KeepAlived

- 一定要完善好切换脚本,keepalived 的切换机制要合理,避免发生切换不成功的现象
- 从库的配置尽量要与主库的一致,不能差太多,避免主从宕机时发生切换,新的主库影响线上业务的进行
- 对于延迟的问题,在这套架构中不可避免,可以改变架构模式,使用PXC完成时间同步功能,基本可以达到没有延迟
- KeepAlived无法解决脑裂问题,因此在进行服务异常判断时,可以修改判断脚本,通过对第三方节点补充检测来决定是否要进行切换,可以降低脑裂问题产生的风险
- 采用KeepAlived架构,在设置量节点状态时,都要设置成backup状态,而且还都是不抢占模式,通过优先级来决定谁是主库,避免发生脑裂,冲突现象

- 安装好MySQL需要的一些依赖包,建议配置yml源用yum安装KeepAvalied即可

## PXC

优点:

- 实现MySQL数据库集群架构的高可用性和数据的强一致性
- 完成了真正的多节点读写的集群方案
- 完善了传统意义上的主从复制延迟的问题,基本上达到了实时同步
- 对于新加入的节点可以自动部署,无需手动备份,维护起来也很方便
- 由于是多节点写入,所以发生数据切换很容易

缺点:

- 新加入的节点开销大,需要复制完整的数据,采用SST传输开销太大
- 任何更新事务都需要全局验证通过,才会在每个节点库上执行,集群性能受限于性能最差的节点,也即是短板效应
- 因为需要保证数据的一致性,所以在多节点并发写时,锁冲突问题比较严重
- 只支持InnoDB存储引擎
- 没有表级别的锁,执行ddl语句会把整张表锁住,而且也kill不了(建议使用OSC操作
- 所有的表必须有主键,不然会报错

