# [QA]如何解决主从复制的延迟问题

---

[TOC]

 [012-MySQL主从复制的具体原理是什么.md](012-MySQL主从复制的具体原理是什么.md) 

## 主从复制延迟的根本原因

主库可以并发写入,但是从库只能通过 SQL thread 完成任务(5.7 之前) .这是出现主从延迟的最核心原因

- MySQL 主从复制的同步本来就不是实时同步的,是异步的,也就是说, 主库提交事务之后,从库才再执行一遍
- 在主库上对没有索引的大表的列进行 delete 或者 update 操作
- 从库的硬件配置没有主库的好, 经常忽略从库的重要性
- 网络抖动导致 IO线程复制延迟

## 怎么监控

- 可以通过第三方工具(瑞士军刀 percona-toolkit)中的 pt-heartbeat 命令进行主从延迟的监控
- 传统方法: 通过比较主从服务器之间的 position 号的差异
- 还可以通过查看 seconds_behind_master 估算一下主从延迟时间

## 怎么优化

- 如果使用的是 5.7 ,可以开启并行复制 ,简单来说就是主表并行执行 SQL 语句,从库也可以通过多个 worker 线程并发执行 relay log 中 主库并把 5.7 版本中的新添加的 slave_parallel_type 参数设置为 LOGICAL_CLOCK 
- 可以采用 PXC 架构,这种架构可以实现多节点的写入,达到实时同步
- 业务初期规划时,就要选择合适的分库分表策略,避免单表或者单库过大,带来额外的复制压力,从而减少主从延迟的时间
- 阵列级别要选择 RAID 10 , raid cache 的策略要采用 WB, 坚决不要采用 WT
- IO调度要选择 deadline 模式
- 适当调整 bufferpool 的大小
- 避免在数据库做大量运算,数据库是用在存储数据的应该让应用端多分担一些压力,或者可以通过缓存来完成

