# 聚合操作

`Collections`集合的意义在于存储和检索元素，下面是一个简单的例子：展示了聚合操作带来的便利性与j简介。

假如你想创建一个社交网络应用，你想创建一个系统管理员来管理一些行为，例如给特定用户发送消息。

会员：

```
public class Person {

    public enum Sex {
        MALE, FEMALE
    }

    String name;
    LocalDate birthday;
    Sex gender;
    String emailAddress;
    
    // ...

    public int getAge() {
        // ...
    }

    public String getName() {
        // ...
    }
}
```

我们将所有的成员放在在`roster`里，那么我们将会这样遍历：

```
for (Person p : roster) {
    System.out.println(p.getName());
}
```

我们还可以使用**使用聚合操作** 遍历：

```
roster
    .stream()
    .forEach(e -> System.out.println(e.getName());
```

当进行批量数量以及更复杂的任务时，会更简洁。

下面会分两个方面介绍它：

- 管道和流
- 迭代器与聚合操作的区别

## 管道和流

管道是多个聚合操作的序列，下面的例子打印了会员集合`roster`里面的男性，本例子用到了包含聚合操作`filter`和`forEach`的管道：

```java
roster
    .stream()
    .filter(e -> e.getGender() == Person.Sex.MALE)
    .forEach(e -> System.out.println(e.getName()));
```

我们可以和`for-each`循环做个比较：

```java
for (Person p : roster) {
    if (p.getGender() == Person.Sex.MALE) {
        System.out.println(p.getName());
    }
}
```

一个管道包含以下组成：

- 一个数据源`source`，这个源可以是一个`collection` 或者`array`或者是`I/O channel` ,在本例中，是一个`collection`

- 0个或者多个中间操作，例如`filter` 它提供一个新的stream

- 终端操作，例如`forEach`，提供一个`非stream`结果集,例如一个原始结果集，一个`Collection`或者`void`



下面这个例子计算了所有男性会员的年龄平均值，使用到聚合函数有`filter`' 、 `mapToInt`、`average`

```
double average = roster
    .stream()
    .filter(p -> p.getGender() == Person.Sex.MALE)
    .mapToInt(Person::getAge)
    .average()
    .getAsDouble();
```

`mapToInt`操作手机了所有男性会员的年龄，并返回一个`stream`

`average` 操作计算了流中的所有元素的平均值，类型为`IntStream`，返回一个`OptionalDouble`类型，如果`stream`不包含元素，那么会返回一个空的`OptionalDouble`实例，当调用`getAsDouble` throws a `NoSuchElementException`，JDK包含许多类似操作，它们经过计算`stream`返回一个值，这些操作称为`reduction `操作，具体参考`reduction `章节。

## 迭代器与聚合操作的区别

聚合操作和迭代器有以下区别：

- **聚合操作使用内部迭代**

聚合操作没有`next`方法去对下一个元素进行操作，因为有了内部迭代，内部操作时，你的应用决定要迭代哪个集合，但是`JDK`绝定如何迭代；但是在外部迭代时，你就必须在应用中决定如何迭代，内部迭代`JDK`帮你屏蔽了实现细节，如果想并行执行，俺么请参考`Parallelism` 章节。

- **聚合操作处理流中的元素**

聚合操作从`stream`中执行process,不直接修改`collection`,因此，我们叫聚合操作叫流操作.

- **聚合操作支持行为作为参数**

您可以将[lambda表达式](https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html)指定 为大多数聚合操作的参数。这使您可以自定义特定聚合操作的行为。