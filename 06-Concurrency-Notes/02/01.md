[返回目录](/READNE.md)

# 线程安全性

在构建稳健的并发程序时，必须正确地使用线程和锁。要编写线程安全的代码，其核心在于要对状态访问操作进行管理，特别是对**共享的**（Shared）和**可变的**（Mutable）状态的访问。

1. **“共享”**意味着变量可以由多个线程同时访问
2. **“可变”**意味着变量的值在其生命周期内可以发生变化。

我们将像讨论代码那样来讨论线程的安全性，但更加侧重于如何防止在数据上发生不可控的并发访问。

## 什么是对象的状态

对象的状态是指存储在**状态变量**（例如**实例**或者**静态域**）中的数据。对象的状态可能包括其他依赖对象的域。例如某个HashMap的状态不仅存储在HashMap对象本身，还存储在许多Map.Entry对象中。在对象的状态中包含了任何可能影响其外部可见行为的数据。

## 线程安全

定义：当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类时线程安全的。



一个对象是否需要是线程安全，取决于它是否被多个线程访问。这指的是在程序中访问对象的方式，而不是对象要实现的功能。要使得对象是线程安全的，需要采用同步机制来协同对象可变状态的访问。如果无法实现协同，那么可能会导致数据破坏以及其他不该出现的后果。

### 修复线程问题的三个方式

如果当多个线程访问同一个可变的状态变量时，没有使用何时的同步，那么程序就会出现错误，有三种方式可以修复这个问题：

- 不在线程直膝箭共享该状态变量
- 将状态变量修改为不可变的变量
- 在访问状态变量时使用同步

## 同步机制

当多个线程访问某个状态变量并且其中有一个线程执行写入操作时，必须采用同步机制来协同这些线程对变量的访问。

- Synchronized关键字是Java中的主要同步机制，它提供了一种独占所的加锁方式
- volatile类型的变量
- 显式锁（Explicit Lock）
- 原子变量

