# 类加载机制-连接阶段

## 连接

- [连接第1阶段-验证](#连接第1阶段-验证)
- [连接第2阶段-准备](#连接第2阶段-准备)
- [连接第3阶段-解析](#连接第3阶段-解析)

### 连接第1阶段-验证

确保 Class文件符合当前虚拟机的要求,保障虚拟机自身的安全,只有通过验证的 Class 文件才能被 JVM 加载

- 文件格式校验 

  > 验证字节流是否符合 Class 文件规范, 是否是 0xCAFEBABE 开头,主次版本号等等

- 元数据校验

  > 对字节码描述的信息进行语义分析,以保证其描述的信息符合 Java 语言规范的要求
  >
  > 例如, 除了 Object 都应该有父类

- 字节码校验

  > 主要目的是通过数据流分析和控制流分析,确定成语语义是否合法,符合逻辑的

- 符号引用校验

  > 该类是否缺少或者被禁止访问它依赖的某些外部类,方法,字段等资源
  >
  > - 符号引用通过字符串描述的全限定名能否找到对应的类
  >
  > - 指定类里是否包含符合方法的字段描述符以及简单名称锁描述的方法和字段

### 连接第2阶段-准备

主要工作时在方法区中为**类变量分配内存空间**并设置类的变量的初始值

初始值指的是不同数据类型的默认值,这里需要注意 final 类型的变量和非 final类型的变量在准备阶段数据数据初始化过程不同

```java
public static long value = 1000;
```

- 静态变量 value 在准备阶段初始值 0 
- 对象初始化阶段将 value 设置为 1000

这是因为静态变量的初始化操作是定义在构造器中

如果将变量定义为 final 变量

```
public static final int vlaue = 1000;
```

JVM 在编译阶段会为 final 类型的变量 value 生成器对应的 ConstantValue 属性,虚拟机在准备阶段会根据 ConstantValue 属性将 value 设置为 1000

<img src="../../assets/image-20200620233056117.png" alt="image-20200620233056117" style="zoom:50%;" />

### 连接第3阶段-解析

解析阶段的主要做的是 : **JVM 会将常量池中的符号引用替换为直接引用**

符号引用是 Class 文件格式内多次出现的, 以 

- CONSTANT_Class_info
- CONSTANT_Fieldref_info 
- CONSTANT_Methodref_info 

等类型的常量出现

#### 什么是符号引用

符号引用 (Symbolic Reference) :  符号引用以一组符号来描述所引用的目标, 符号可以是**任何形式的字面量** , 只要使用时能无歧义地定位到目标即可

符号引用 与虚拟机实现的内存布局无关,引用目标并不一定是已经加载到虚拟机内存当中的内容

各种虚拟机实现的内存布局可以各不相同, 但是它们能够接受的符号引用必须是一致的, 因为符号引用的字面量形式明确定义在<Java 虚拟机规范> 的 class 文件格式中

#### 什么是直接引用

直接引用(Direct refeerence) : 直接引用时可以直接指向目标的指针、相对偏移量或者是一个能够间接定位到目标的句柄 

**直接引用和虚拟机的内存实现直接相关** 同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同, 如果有了直接引用, 那引用的目标必定已经在虚拟机的内存中存在

#### 解析发生的具体时间

java 虚拟机规范 中没有具体规定解析阶段发生的具体时间, 只要求了在执行 ane-warray , checkcast, getfield, getstatic, instanceof, invokebynamic, invokeinterface, invoke-special, invokestatic, ldc, ldc_w, ldc2_2 , multianewarray, new, putfield 和 putstatic  这 17 个用于操作符号引用的字节指令之前,先对他们所使用的符号引用进行解析

所以虚拟机实现可以根据需要来自行判断,到底是在类被加载器加载时就对常量池中的符号引用进行解析,还是等待一个符号引用将要被使用前才会解析它



> ![image-20200620233534054](../../assets/image-20200620233534054.png)
>
> ![image-20200620233622437](../../assets/image-20200620233622437.png)

## 