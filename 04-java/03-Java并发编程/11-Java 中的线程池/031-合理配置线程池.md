# 合理配置线程池

首先要对任务特性进行分析,可以从以下几个角度分析

- 任务的性质
  - [CPU密集型](#CPU密集型)
  - [IO密集型任务](#IO密集型任务)
  - [混合型任务](#混合型任务)
- 任务的优先级
  - 优先级高
  - 优先级中
  - 优先级低
- 任务的执行时间
  - 执行时间长
  - 执行时间短
  - 指向时间中

- 任务的依赖性

  > 是否依赖其他系统资源,如数据库连接

## 性质不同的的任务可以用不同规模的线程池处理

### CPU密集型

CPU密集型任务应该配置尽可能**小**的线程 ,CPU密集型主要是执行计算任务，响应时间很快，cpu 一直在运行，这种任务 cpu 的利用率很高，那么线程数的配置应该根据 CPU 核心数来决定

建议

- 最大线程数 =CPU 核心数 + 1
- 最大并行任务数 = CPU核心数

### IO密集型任务

由于IO密集型任务并不是一直在执行任务,则应配置尽可能多的线程, IO密集型任务主要是进行 IO 操作，执行 IO 操作的时间较长，这是 cpu 出于空闲状态， 导致 cpu 的利用率不高，这种情况下可以增加线程池的大小。这种情况下可以结合线程的等待时长来做判断，等待时间越高，那么线程数也相对越多。**一般可以配置 cpu 核心数的 2 倍**。 

建议

- 2* cpu 核心数
- 线程池线程数目 = (线程池设定的线程等待时间 + 线程CPU时间) / 线程CPU时间 ) * CPU数目

> **线程 cpu 时间** 是预估的程序单个线程在 cpu 上运行的时间(通常使用 loadrunner 测试大量运行次数求出平均值)

### 混合型任务

如果可以拆分,将其拆分成一个CPU密集型任务和一个IO密集型任务, 只要两个任务执行的时间相差不大,那么分解后执行的吞吐量将高于串行执行的吞吐量

如果这两个任务执行相差时间太大,那么分解后执行的吞吐量将高于串行执行的吞吐量

如果这链各个任务执行时间相差太大,则没必要进行分解,可以通过`Runtime.getRuntime().availableProcessors()`方法获得当前设备的CPU个数

## 任务的优先级

优先级不同的任务可以使用优先级队列PriorityBlockingQueue来处理。它可以让优先级高的任务先执行

## 建议使用有界队列

**有界队列能增加系统的稳定性和预警能力,可以根据需要设置大一点,比如几千**

如果系统中的线程池队列和线程池全满了,不断抛出抛弃任务的异常,通过排查发现是数据库出现了问题 , 导致执行SQL变得非常缓慢 , 因为后台任务线程池里的任务全都是需要向数据库查询和插入数据的,所以导致线程池里的工作线程全部阻塞,任务挤压在线程池里

如果我们设置成无界队列,那么线程池的队列就会越来越多,有可能会撑满内存,导致整个系统不可用,而不只是后台任务出现问题,我们系统所有的任务时用单独的服务器部署的,我们使用不同规模的线程池完成不同类型的任务,但是出现这种问题时也会影响到其他任务



